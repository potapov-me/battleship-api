# Миграция хранения комнат на Redis

## Обзор изменений

Проект был успешно мигрирован с хранения комнат в памяти процесса на Redis. Это обеспечивает:
- Масштабируемость (несколько экземпляров приложения могут работать с одними данными)
- Персистентность данных
- Автоматическое истечение срока действия (TTL)
- Лучшую производительность при большом количестве комнат

## Что было изменено

### 1. Зависимости
- Добавлены `redis` и `ioredis` пакеты
- Удален `@nestjs/redis` (не найден в npm registry)

### 2. Конфигурация
- Добавлены переменные окружения для Redis в `example.env`:
  - `REDIS_HOST` (по умолчанию localhost)
  - `REDIS_PORT` (по умолчанию 6379)
  - `REDIS_PASSWORD` (необязательно)
  - `REDIS_DB` (по умолчанию 0)

### 3. Новые модули и сервисы
- `src/shared/redis.module.ts` - модуль для подключения к Redis
- `src/shared/redis.service.ts` - сервис для работы с Redis
- Обновлен `src/shared/shared.module.ts` для экспорта Redis сервисов

### 4. Обновленный RoomService
- Все методы стали асинхронными
- Хранение в Redis с TTL 24 часа
- Использование префикса `room:` для ключей
- Автоматическая сериализация/десериализация JSON

### 5. Обновленные контроллеры
- `src/game/room.controller.ts` - все методы стали асинхронными

### 6. Обновленные тесты
- `src/game/room.service.spec.ts` - добавлены моки для Redis
- Все тесты стали асинхронными

### 7. Docker
- Redis уже был добавлен в `docker-compose.yml`
- Обновлены инструкции по запуску

### 8. Документация
- Обновлен `README.md` с информацией о Redis
- Добавлен скрипт `scripts/test-redis.js` для тестирования подключения
- Добавлен скрипт `npm run test:redis`

## API изменения

Все эндпоинты комнат остались теми же, но теперь работают асинхронно:

- `POST /rooms` - создание комнаты
- `POST /rooms/:id/join` - присоединение к комнате  
- `GET /rooms` - список активных комнат

## Запуск

1. Запустите Redis:
```bash
docker compose up -d redis
```

2. Проверьте подключение:
```bash
npm run test:redis
```

3. Запустите приложение:
```bash
npm run start:dev
```

## Преимущества новой реализации

1. **Масштабируемость**: Можно запускать несколько экземпляров приложения
2. **Надежность**: Данные сохраняются между перезапусками
3. **Производительность**: Redis оптимизирован для быстрых операций
4. **Автоматическая очистка**: Комнаты автоматически удаляются через 24 часа
5. **Мониторинг**: Легко отслеживать количество активных комнат

## Обратная совместимость

API остался полностью совместимым. Единственное изменение - все операции стали асинхронными, что улучшает производительность.
